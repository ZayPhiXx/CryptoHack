from pwn import * # pip install pwntools
import json
import base64
import codecs

r = remote('socket.cryptohack.org', 13377, level = 'debug')

def json_recv():
    line = r.recvline()
    return json.loads(line.decode())

def json_send(hsh):
    request = json.dumps(hsh).encode()
    r.sendline(request)
    
def Base64Decode(hsh):
    return base64.b64decode(hsh)

def HexDecode(hsh):
    return bytes.fromhex(hsh)

def Rot13Decode(hsh):
    return codecs.decode(hsh, 'rot_13')

def BigIntDecode(hsh):
    return int(hsh, 16).to_bytes((int(hsh, 16).bit_length() + 7) // 8, 'big')

def Utf8Decode(hsh):
    return bytes(hsh).decode('utf-8')
    


def decode_dispatcher(t, encoded):
    if t == 'base64':
        return Base64Decode(encoded)
    if t == 'hex':
        return HexDecode(encoded)
    if t == 'rot13':
        return Rot13Decode(encoded)
    if t == 'bigint':
        return BigIntDecode(encoded)
    if t == 'utf-8':
        return Utf8Decode(encoded)
    return encoded


def normalize_decoded(msg):
    if isinstance(msg, (bytes, bytearray)):
        try:
            return msg.decode('utf-8')
        except UnicodeDecodeError:
            return msg.decode('latin-1')
    if isinstance(msg, int):
        return str(msg)
    if isinstance(msg, str):
        return msg
    return str(msg)


def solve_all():
    try:
        while True:
            received = json_recv()
            print(received)

            if 'error' in received:
                print('Server error:', received['error'])
                break
            if 'flag' in received:
                print('Flag:', received['flag'])
                break

            t = received.get('type')
            encoded = received.get('encoded')

            decoded = decode_dispatcher(t, encoded)
            answer = normalize_decoded(decoded)

            json_send({'decoded': answer})

    except Exception as e:
        print('Exception during solve:', e)
    finally:
        r.close()



solve_all()
